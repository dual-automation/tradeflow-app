import { createClient } from "https://esm.sh/@supabase/supabase-js@2";


// 1) PASTE YOUR VALUES HERE:
const SUPABASE_URL = "PASTE_SUPABASE_PROJECT_URL";
const SUPABASE_ANON_KEY = "PASTE_SUPABASE_ANON_PUBLIC_KEY";


// 2) SET YOUR AI URLs HERE:
const PRO_AI_URL = "PASTE_PRO_AI_URL";
const ADV_AI_URL = "PASTE_ADVANCED_AI_URL";


const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);


const $ = (id) => document.getElementById(id);


async function getPlan(userId) {
  // Assumes you have a subscriptions table with user_id, plan_code, status
  const { data, error } = await supabase
    .from("subscriptions")
    .select("plan_code,status")
    .eq("user_id", userId)
    .single();


  if (error) return null;
  if (!data) return null;
  if (data.status !== "active") return null;
  return data.plan_code;
}


async function showApp(session) {
  const user = session.user;
  $("userLabel").textContent = user.email;


  const plan = await getPlan(user.id);


  if (!plan) {
    $("msg").textContent = "No active subscription found for this account.";
    $("authBox").style.display = "block";
    $("appBox").style.display = "none";
    return;
  }


  $("planLabel").textContent = plan === "advanced" ? "Advanced Access" : "Pro Access";
  $("aiFrame").src = plan === "advanced" ? ADV_AI_URL : PRO_AI_URL;


  $("authBox").style.display = "none";
  $("appBox").style.display = "block";
}


async function init() {
  const { data } = await supabase.auth.getSession();
  if (data.session) await showApp(data.session);


  $("loginBtn").onclick = async () => {
    $("msg").textContent = "Signing in…";
    const email = $("email").value.trim();
    const password = $("password").value;


    const { data, error } = await supabase.auth.signInWithPassword({ email, password });
    if (error) return ($("msg").textContent = error.message);
    $("msg").textContent = "";
    await showApp(data.session);
  };


  $("signupBtn").onclick = async () => {
    $("msg").textContent = "Creating account…";
    const email = $("email").value.trim();
    const password = $("password").value;


    const { data, error } = await supabase.auth.signUp({ email, password });
    if (error) return ($("msg").textContent = error.message);
    $("msg").textContent = "Account created. Now sign in.";
  };


  $("logoutBtn").onclick = async () => {
    await supabase.auth.signOut();
    location.reload();
  };
}


init();